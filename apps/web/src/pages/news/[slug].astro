---
// import type { Any } from '@sanity/client'
import Layout from "../../layouts/Layout.astro";
import { getNewsBySlug, getAllNewsSlugs } from "../../lib/sanity/queries";
import { getSanityImageUrl, formatDate } from "../../lib/utils/sanity";
import "../../styles/global.css";

// Generate static paths for all news articles
export async function getStaticPaths() {
  const newsSlugs = await getAllNewsSlugs();
  return newsSlugs.map((item: any) => ({
    params: { slug: item.slug },
  }));
}

const { slug } = Astro.params;
const article = await getNewsBySlug(slug || "");

if (!article) {
  return Astro.redirect("/404");
}

const pageTitle = article.seo?.title || article.title || "News Article";
const pageDescription =
  article.seo?.description ||
  article.excerpt ||
  "Read the latest news from OLOPSC";
const ogImage =
  article.seo?.image?.asset?.url || article.featuredImage?.asset?.url;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  ogImage={ogImage}
  ogType="article"
>
  <article class="bg-[var(--color-neutral)] min-h-screen">
    {/* Hero Image */}
    {
      article.featuredImage?.asset?.url && (
        <div class="w-full h-[60vh] sm:h-[70vh] overflow-hidden">
          <img
            src={getSanityImageUrl(article.featuredImage, {
              width: 1920,
              height: 1080,
              fit: "crop",
            })}
            alt={article.featuredImage.alt || article.title || ""}
            class="w-full h-full object-cover"
          />
        </div>
      )
    }

    {/* Article Content */}
    <div class="container mx-auto px-5 py-10 sm:px-[60px] sm:py-16">
      <div class="max-w-4xl mx-auto">
        {/* Header */}
        <header class="mb-8">
          {
            article.category && (
              <span class="inline-block text-small-mobile sm:text-small-desktop text-[var(--color-accent)] font-semibold uppercase mb-4">
                {article.category}
              </span>
            )
          }
          <h1
            class="text-section-header-mobile sm:text-section-header-desktop text-[var(--color-primary)] mb-4"
          >
            {article.title}
          </h1>

          {/* Meta Information */}
          <div
            class="flex flex-wrap items-center gap-4 text-main-mobile sm:text-main-desktop text-[var(--color-primary)]/70 mb-6"
          >
            {
              article.publishedAt && (
                <time datetime={article.publishedAt}>
                  {formatDate(article.publishedAt)}
                </time>
              )
            }
            <span class="text-[var(--color-primary)]/80">
              {article.academicDepartment?.title || "General"}
            </span>
            {
              article.author?.name && (
                <span class="flex items-center gap-2">
                  {article.author.image?.asset?.url && (
                    <img
                      src={getSanityImageUrl(article.author.image, {
                        width: 32,
                        height: 32,
                        fit: "crop",
                      })}
                      alt={
                        article.author.image.alt || article.author.name || ""
                      }
                      class="w-8 h-8 rounded-full object-cover"
                    />
                  )}
                  <span>{article.author.name}</span>
                </span>
              )
            }
          </div>

          {/* Excerpt */}
          {
            article.excerpt && (
              <p class="text-xl sm:text-2xl text-[var(--color-primary)]/80 leading-relaxed mb-6">
                {article.excerpt}
              </p>
            )
          }
        </header>

        {/* Tags */}
        {
          article.tags && article.tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-8">
              {article.tags.map((tag: string) => (
                <span class="px-3 py-1 bg-[var(--color-primary)]/10 text-[var(--color-primary)] rounded-full text-small-mobile sm:text-small-desktop">
                  #{tag}
                </span>
              ))}
            </div>
          )
        }

        {/* Main Content - Portable Text */}
        {
          article.content && article.content.length > 0 && (
            <div class="prose prose-lg max-w-none mb-12">
              {article.content.map((block: any) => {
                if (block._type === "block") {
                  const style = block.style || "normal";
                  const Tag =
                    style === "h1"
                      ? "h1"
                      : style === "h2"
                        ? "h2"
                        : style === "h3"
                          ? "h3"
                          : style === "h4"
                            ? "h4"
                            : style === "blockquote"
                              ? "blockquote"
                              : "p";

                  // Build HTML content from children
                  let htmlContent = "";
                  block.children?.forEach((child: any) => {
                    let text = child.text || "";

                    // Apply marks
                    if (child.marks && child.marks.length > 0) {
                      child.marks.forEach((mark: any) => {
                        // String marks are decorators (strong, em, etc.)
                        if (typeof mark === "string") {
                          if (mark === "strong") {
                            text = `<strong>${text}</strong>`;
                          } else if (mark === "em") {
                            text = `<em>${text}</em>`;
                          } else if (mark === "underline") {
                            text = `<u>${text}</u>`;
                          } else if (mark === "strike") {
                            text = `<s>${text}</s>`;
                          }
                        } else if (mark?._type === "link") {
                          // Link annotation object
                          const target = mark.openInNewTab
                            ? ' target="_blank" rel="noopener noreferrer"'
                            : "";
                          text = `<a href="${mark.href || "#"}" class="text-[var(--color-accent)] hover:underline"${target}>${text}</a>`;
                        } else {
                          // Mark might be a key reference - look it up in markDefs
                          const markDef = block.markDefs?.find(
                            (def: any) => def._key === mark,
                          );
                          if (markDef?._type === "link") {
                            const target = markDef.openInNewTab
                              ? ' target="_blank" rel="noopener noreferrer"'
                              : "";
                            text = `<a href="${markDef.href || "#"}" class="text-[var(--color-accent)] hover:underline"${target}>${text}</a>`;
                          }
                        }
                      });
                    }

                    htmlContent += text;
                  });

                  const baseClasses =
                    "text-main-mobile sm:text-main-desktop text-[var(--color-primary)] mb-4";
                  const styleClasses =
                    style === "h1"
                      ? "text-section-header-mobile sm:text-section-header-desktop mt-8 mb-4"
                      : style === "h2"
                        ? "text-3xl sm:text-4xl font-bold mt-6 mb-3"
                        : style === "h3"
                          ? "text-2xl sm:text-3xl font-bold mt-6 mb-3"
                          : style === "h4"
                            ? "text-xl sm:text-2xl font-semibold mt-4 mb-2"
                            : style === "blockquote"
                              ? "border-l-4 border-[var(--color-accent)] pl-4 italic my-4"
                              : baseClasses;

                  return <Tag class={styleClasses} set:html={htmlContent} />;
                }

                // Handle images in content
                if (block._type === "image" && block.asset) {
                  return (
                    <figure class="my-8">
                      <img
                        src={getSanityImageUrl(block, {
                          width: 1200,
                          height: 800,
                          fit: "max",
                        })}
                        alt={block.alt || ""}
                        class="w-full h-auto rounded-lg shadow-lg"
                      />
                      {block.caption && (
                        <figcaption class="text-center text-main-mobile sm:text-main-desktop text-[var(--color-primary)]/70 mt-2">
                          {block.caption}
                        </figcaption>
                      )}
                    </figure>
                  );
                }

                // Handle video embeds
                if (block._type === "videoEmbed" && block.url) {
                  let embedUrl = "";
                  if (block.platform === "youtube") {
                    // Extract YouTube video ID from URL
                    const match = block.url.match(
                      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    );
                    const videoId = match ? match[1] : "";
                    if (videoId) {
                      embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    }
                  } else if (block.platform === "vimeo") {
                    // Extract Vimeo video ID from URL
                    const match = block.url.match(/(?:vimeo\.com\/)(\d+)/);
                    const videoId = match ? match[1] : "";
                    if (videoId) {
                      embedUrl = `https://player.vimeo.com/video/${videoId}`;
                    }
                  }

                  return (
                    <div class="my-8 aspect-video">
                      {embedUrl ? (
                        <iframe
                          src={embedUrl}
                          class="w-full h-full rounded-lg"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                          allowfullscreen
                          title={block.title || "Video embed"}
                        />
                      ) : (
                        <video
                          src={block.url}
                          controls
                          class="w-full h-full rounded-lg"
                        />
                      )}
                    </div>
                  );
                }

                return null;
              })}
            </div>
          )
        }

        {/* Gallery */}
        {
          article.gallery &&
            article.gallery.images &&
            article.gallery.images.length > 0 && (
              <section class="mb-12">
                {article.gallery.title && (
                  <h2 class="text-3xl sm:text-4xl font-bold text-[var(--color-primary)] mb-6">
                    {article.gallery.title}
                  </h2>
                )}
                <div
                  class={`grid gap-4 ${
                    article.gallery.layout === "masonry"
                      ? "grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
                      : "grid-cols-1 md:grid-cols-2 lg:grid-cols-3"
                  }`}
                >
                  {article.gallery.images.map((item: any) => (
                    <figure class="rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow">
                      <img
                        src={getSanityImageUrl(item.image, {
                          width: 600,
                          height: 400,
                          fit: "crop",
                        })}
                        alt={item.image?.alt || item.caption || ""}
                        class="w-full h-full object-cover"
                      />
                      {item.caption && (
                        <figcaption class="p-3 text-main-mobile sm:text-main-desktop text-[var(--color-primary)] text-center">
                          {item.caption}
                        </figcaption>
                      )}
                    </figure>
                  ))}
                </div>
              </section>
            )
        }

        {/* Related Articles */}
        {
          article.relatedArticles && article.relatedArticles.length > 0 && (
            <section class="mt-12 pt-12 border-t border-[var(--color-primary)]/20">
              <h2 class="text-3xl sm:text-4xl font-bold text-[var(--color-primary)] mb-8">
                Related Articles
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {article.relatedArticles.map((related: any) => (
                  <a
                    href={`/news/${related.slug?.current || ""}`}
                    class="bg-white rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow group"
                  >
                    {related.featuredImage?.asset?.url && (
                      <div class="aspect-video overflow-hidden">
                        <img
                          src={getSanityImageUrl(related.featuredImage, {
                            width: 400,
                            height: 300,
                            fit: "crop",
                          })}
                          alt={related.featuredImage.alt || related.title || ""}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        />
                      </div>
                    )}
                    <div class="p-4">
                      <h3 class="text-card-title-mobile sm:text-card-title-desktop text-[var(--color-primary)] mb-2 group-hover:text-[var(--color-accent)] transition-colors">
                        {related.title}
                      </h3>
                      {related.publishedAt && (
                        <p class="text-small-mobile sm:text-small-desktop text-[var(--color-primary)]/70">
                          {formatDate(related.publishedAt)}
                        </p>
                      )}
                    </div>
                  </a>
                ))}
              </div>
            </section>
          )
        }
      </div>
    </div>
  </article>
</Layout>
