---
import { PortableText } from "astro-portabletext";
import { ChevronDown, HelpCircle } from "lucide-astro";

interface Props {
    program: any; // Using any for now to avoid complex type duplication, but should match schema
}

const { program } = Astro.props;

// Helper to format date if utility not available
const formattedDeadline = program.deadline
    ? new Date(program.deadline).toLocaleDateString("en-US", {
          month: "long",
          day: "numeric",
          year: "numeric",
      })
    : null;
---

<div
    class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100 flex flex-col group"
>
    <!-- Image Header -->
    <div class="relative h-48 sm:h-56 overflow-hidden">
        {
            program.image?.asset?.url ? (
                <img
                    src={program.image.asset.url}
                    alt={program.image.alt || program.name}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                />
            ) : (
                <div class="w-full h-full bg-gradient-to-br from-[var(--color-primary)] to-[#1a1970] flex items-center justify-center p-6">
                    <span class="text-white opacity-20 transform -rotate-12 select-none font-serif text-4xl">
                        Scholarship
                    </span>
                </div>
            )
        }
        <div class="absolute top-4 left-4">
            <span
                class="bg-white/90 backdrop-blur-sm text-[var(--color-primary)] px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm"
            >
                {
                    program.type === "academic"
                        ? "Academic Excellence"
                        : program.type === "athletic"
                          ? "Athletic"
                          : program.type === "arts"
                            ? "Arts & Culture"
                            : program.type === "financial"
                              ? "Financial Aid"
                              : program.type === "merit"
                                ? "Merit-Based"
                                : program.type === "community"
                                  ? "Community Service"
                                  : program.type === "alumni"
                                    ? "Alumni"
                                    : program.type === "other"
                                      ? "Special Program"
                                      : program.type
                }
            </span>
        </div>
    </div>

    <!-- Content Body -->
    <div class="p-6 md:p-8 flex-1 flex flex-col">
        <h3
            class="text-2xl font-serif text-[var(--color-primary)] mb-2 group-hover:text-[var(--color-accent)] transition-colors min-h-[64px]"
        >
            {program.name}
        </h3>

        <!-- Coverage Highlight -->
        <div class="mb-4 space-y-2">
            {
                program.coverage?.percentage && (
                    <div class="text-[var(--color-accent)] font-bold text-lg leading-tight">
                        {program.coverage.percentage} Cover
                    </div>
                )
            }

            {
                program.coverage?.amount && (
                    <div class="text-gray-700 font-medium">
                        Amount: {program.coverage.amount}
                    </div>
                )
            }

            {
                program.coverage?.details && (
                    <p class="text-sm text-gray-600 italic">
                        {program.coverage.details}
                    </p>
                )
            }
        </div>

        <!-- Description -->
        <div
            class="prose prose-sm text-gray-600 mb-6 line-clamp-3 min-h-[60px]"
        >
            {
                program.description && (
                    <PortableText value={program.description} />
                )
            }
        </div>

        <div class="mt-auto space-y-4">
            <!-- Key Details Grid -->
            <div
                class="grid grid-cols-2 gap-4 text-sm border-t border-gray-100 pt-4"
            >
                {
                    program.eligibility?.gpa && (
                        <div>
                            <span class="block text-gray-500 text-xs uppercase tracking-wide font-semibold">
                                Min. GPA
                            </span>
                            <span class="font-medium text-[var(--color-primary)]">
                                {program.eligibility.gpa}
                            </span>
                        </div>
                    )
                }
                {
                    formattedDeadline && (
                        <div>
                            <span class="block text-gray-500 text-xs uppercase tracking-wide font-semibold">
                                Deadline
                            </span>
                            <span class="font-medium text-[var(--color-primary)]">
                                {formattedDeadline}
                            </span>
                        </div>
                    )
                }
            </div>

            <!-- Expandable Details -->
            <div class="border-t border-gray-100 pt-2 space-y-2">
                {/* Requirements */}
                {
                    program.eligibility?.requirements &&
                        program.eligibility.requirements.length > 0 && (
                            <details class="group/details">
                                <summary class="cursor-pointer text-sm font-semibold text-[var(--color-primary)] hover:text-[var(--color-accent)] transition-colors flex items-center justify-between py-2 list-none">
                                    <span>Eligibility & Requirements</span>
                                    <ChevronDown className="w-4 h-4 transition-transform group-open/details:rotate-180" />
                                </summary>
                                <div class="pt-2 pb-4 text-sm text-gray-600 animate-in slide-in-from-top-1 duration-200">
                                    <ul class="list-disc pl-4 space-y-1">
                                        {program.eligibility.requirements.map(
                                            (req: string) => (
                                                <li>{req}</li>
                                            ),
                                        )}
                                    </ul>
                                    {program.documents &&
                                        program.documents.length > 0 && (
                                            <div class="mt-3">
                                                <p class="font-medium text-[var(--color-primary)] mb-1">
                                                    Required Documents:
                                                </p>
                                                <ul class="list-disc pl-4 space-y-1">
                                                    {program.documents.map(
                                                        (doc: string) => (
                                                            <li>{doc}</li>
                                                        ),
                                                    )}
                                                </ul>
                                            </div>
                                        )}
                                </div>
                            </details>
                        )
                }

                {/* Application Process */}
                {
                    program.applicationProcess && (
                        <details class="group/details">
                            <summary class="cursor-pointer text-sm font-semibold text-[var(--color-primary)] hover:text-[var(--color-accent)] transition-colors flex items-center justify-between py-2 list-none">
                                <span>How to Apply</span>
                                <ChevronDown className="w-4 h-4 transition-transform group-open/details:rotate-180" />
                            </summary>
                            <div class="pt-2 pb-4 text-sm text-gray-600 prose prose-sm max-w-none">
                                <PortableText
                                    value={program.applicationProcess}
                                />
                            </div>
                        </details>
                    )
                }

                {/* Contact */}
                {
                    program.contact && (
                        <div class="pt-4 mt-2 border-t border-gray-100 flex items-center gap-2 text-xs text-gray-500">
                            <HelpCircle className="w-4 h-4" />
                            <span>
                                Questions? Contact{" "}
                                <span class="font-medium text-[var(--color-primary)]">
                                    {program.contact.name || "Admissions"}
                                </span>
                            </span>
                        </div>
                    )
                }
            </div>
        </div>
    </div>
</div>
