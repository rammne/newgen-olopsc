---
import {getSanityImageUrl} from '../../lib/utils/sanity'
import Stats from '../homepage/Stats.astro'
import Testimonials from '../homepage/Testimonials.astro'

interface Props {
  storyBlocks: Array<{
    blockType?: string
    headline?: string
    caption?: string
    image?: {
      asset?: {
        url?: string
      }
      alt?: string
    }
    video?: {
      url?: string
      provider?: string
      embedId?: string
    }
    images?: Array<{
      image?: {
        asset?: {
          url?: string
        }
        alt?: string
      }
      caption?: string
    }>
    textContent?: string
    imagePosition?: string
    gridColumns?: number
    backgroundColor?: string
    spacing?: string
    stats?: Array<any>
    quote?: any
  }>
}

const {storyBlocks} = Astro.props

if (!storyBlocks || storyBlocks.length === 0) {
  return null
}

const getBackgroundClass = (bg?: string) => {
  switch (bg) {
    case 'primary':
      return 'bg-[var(--color-primary)]'
    case 'light':
      return 'bg-[var(--color-neutral)]/40'
    case 'dark':
      return 'bg-[var(--color-neutral)]'
    default:
      return 'bg-white'
  }
}

const getSpacingClass = (spacing?: string) => {
  switch (spacing) {
    case 'compact':
      return 'py-8 sm:py-10'
    case 'large':
      return 'py-16 sm:py-24'
    default:
      return 'py-10 sm:py-16'
  }
}
---

{storyBlocks.map((block, index) => {
  const bgClass = getBackgroundClass(block.backgroundColor)
  const spacingClass = getSpacingClass(block.spacing)
  const textColor = block.backgroundColor === 'primary' || block.backgroundColor === 'dark' ? 'text-white' : 'text-[var(--color-primary)]'
  
  if (block.blockType === 'image' && block.image?.asset?.url) {
    return (
      <section class={`min-h-[60vh] px-5 sm:px-[60px] ${spacingClass} ${bgClass} border-t border-[var(--color-neutral)]/30`}>
        <div class="container mx-auto max-w-4xl">
          {block.headline && (
            <h2 class={`text-section-header-mobile sm:text-section-header-desktop ${textColor} text-center mb-4`}>
              {block.headline}
            </h2>
          )}
          <div class="rounded-2xl overflow-hidden shadow-xl">
            <img
              src={getSanityImageUrl(block.image, {width: 1200, height: 800, fit: 'max'})}
              alt={block.image.alt || block.headline || ''}
              class="w-full h-auto"
            />
          </div>
          {block.caption && (
            <p class={`text-main-mobile sm:text-main-desktop ${textColor} text-center mt-6`}>
              {block.caption}
            </p>
          )}
        </div>
      </section>
    )
  }

  if (block.blockType === 'imageGrid' && block.images && block.images.length > 0) {
    const cols = block.gridColumns || 3
    const gridClass = cols === 2 ? 'grid-cols-1 md:grid-cols-2' : cols === 4 ? 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4' : 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3'
    
    return (
      <section class={`min-h-[60vh] px-5 sm:px-[60px] ${spacingClass} ${bgClass} border-t border-[var(--color-neutral)]/30`}>
        <div class="container mx-auto max-w-full">
          {block.headline && (
            <h2 class={`text-section-header-mobile sm:text-section-header-desktop ${textColor} text-center mb-8`}>
              {block.headline}
            </h2>
          )}
          <div class={`grid ${gridClass} gap-6 max-w-6xl mx-auto`}>
            {block.images.map((item) => (
              <div class="rounded-xl overflow-hidden shadow-md">
                {item.image?.asset?.url && (
                  <img
                    src={getSanityImageUrl(item.image, {width: 600, height: 400, fit: 'crop'})}
                    alt={item.image.alt || item.caption || ''}
                    class="w-full h-auto object-cover"
                  />
                )}
                {item.caption && (
                  <p class={`p-4 text-main-mobile sm:text-main-desktop ${textColor} text-center`}>
                    {item.caption}
                  </p>
                )}
              </div>
            ))}
          </div>
          {block.caption && (
            <p class={`text-main-mobile sm:text-main-desktop ${textColor} text-center mt-8`}>
              {block.caption}
            </p>
          )}
        </div>
      </section>
    )
  }

  if (block.blockType === 'split' && block.image?.asset?.url) {
    const isLeft = block.imagePosition === 'left'
    
    return (
      <section class={`min-h-[60vh] px-5 sm:px-[60px] ${spacingClass} ${bgClass} border-t border-[var(--color-neutral)]/30`}>
        <div class="container mx-auto max-w-full">
          <div class={`grid grid-cols-1 lg:grid-cols-2 gap-8 items-center ${isLeft ? '' : 'lg:flex-row-reverse'}`}>
            {isLeft && (
              <div class="rounded-2xl overflow-hidden shadow-xl">
                <img
                  src={getSanityImageUrl(block.image, {width: 800, height: 600, fit: 'crop'})}
                  alt={block.image.alt || block.headline || ''}
                  class="w-full h-auto"
                />
              </div>
            )}
            <div>
              {block.headline && (
                <h2 class={`text-section-header-mobile sm:text-section-header-desktop ${textColor} mb-4`}>
                  {block.headline}
                </h2>
              )}
              {block.textContent && (
                <p class={`text-main-mobile sm:text-main-desktop ${textColor} mb-4`}>
                  {block.textContent}
                </p>
              )}
              {block.caption && (
                <p class={`text-main-mobile sm:text-main-desktop ${textColor}/80`}>
                  {block.caption}
                </p>
              )}
            </div>
            {!isLeft && (
              <div class="rounded-2xl overflow-hidden shadow-xl">
                <img
                  src={getSanityImageUrl(block.image, {width: 800, height: 600, fit: 'crop'})}
                  alt={block.image.alt || block.headline || ''}
                  class="w-full h-auto"
                />
              </div>
            )}
          </div>
        </div>
      </section>
    )
  }

  if (block.blockType === 'video' && block.video?.url) {
    return (
      <section class={`min-h-[60vh] px-5 sm:px-[60px] ${spacingClass} ${bgClass} border-t border-[var(--color-neutral)]/30`}>
        <div class="container mx-auto max-w-4xl">
          {block.headline && (
            <h2 class={`text-section-header-mobile sm:text-section-header-desktop ${textColor} text-center mb-6`}>
              {block.headline}
            </h2>
          )}
          <div class="aspect-video rounded-2xl overflow-hidden shadow-xl">
            <iframe
              src={block.video.url}
              class="w-full h-full"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
            ></iframe>
          </div>
          {block.caption && (
            <p class={`text-main-mobile sm:text-main-desktop ${textColor} text-center mt-6`}>
              {block.caption}
            </p>
          )}
        </div>
      </section>
    )
  }

  if (block.blockType === 'fullImage' && block.image?.asset?.url) {
    return (
      <section class={`min-h-[80vh] px-5 sm:px-0 ${spacingClass} ${bgClass} border-t border-[var(--color-neutral)]/30`}>
        <div class="relative w-full h-full">
          <img
            src={getSanityImageUrl(block.image, {width: 1920, height: 1080, fit: 'max'})}
            alt={block.image.alt || block.headline || ''}
            class="w-full h-[80vh] object-cover"
          />
          {(block.headline || block.caption) && (
            <div class="absolute inset-0 bg-black/40 flex items-center justify-center">
              <div class="text-center px-5 max-w-4xl">
                {block.headline && (
                  <h2 class={`text-section-header-mobile sm:text-section-header-desktop text-white mb-4`}>
                    {block.headline}
                  </h2>
                )}
                {block.caption && (
                  <p class={`text-main-mobile sm:text-main-desktop text-white`}>
                    {block.caption}
                  </p>
                )}
              </div>
            </div>
          )}
        </div>
      </section>
    )
  }

  if (block.blockType === 'stats' && block.stats && block.stats.length > 0) {
    return (
      <section class={`min-h-[60vh] px-5 sm:px-[60px] ${spacingClass} ${bgClass} border-t border-[var(--color-neutral)]/30`}>
        {block.headline && (
          <h2 class={`text-section-header-mobile sm:text-section-header-desktop ${textColor} text-center mb-8`}>
            {block.headline}
          </h2>
        )}
        <Stats keyStats={{stats: block.stats}} />
        {block.caption && (
          <p class={`text-main-mobile sm:text-main-desktop ${textColor} text-center mt-8 max-w-3xl mx-auto`}>
            {block.caption}
          </p>
        )}
      </section>
    )
  }

  if (block.blockType === 'quote' && block.quote) {
    return (
      <section class={`min-h-[60vh] px-5 sm:px-[60px] ${spacingClass} ${bgClass} border-t border-[var(--color-neutral)]/30`}>
        <div class="container mx-auto max-w-4xl">
          <Testimonials testimonials={{testimonials: [block.quote]}} />
        </div>
      </section>
    )
  }

  return null
})}


