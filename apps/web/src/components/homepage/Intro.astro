---
import CtaButton from "../common/CtaButton.astro";

interface Props {
  intro: {
    headline?: string;
    subheadline?: string;
    content?: any[] | string;
    image?: {
      asset?: {
        url?: string;
      };
      alt?: string;
    };
    video?: {
      url?: string;
      provider?: string;
      embedId?: string;
    };
    cta?: {
      text?: string;
      link?: any;
      style?: string;
      openInNewTab?: boolean;
    };
  };
}

const { intro } = Astro.props;
---

<section
  class="relative min-h-[85vh] px-5 py-10 sm:px-[60px] sm:py-[100px] flex flex-col justify-end overflow-hidden bg-neutral border-t border-[var(--color-neutral)]/30"
>
  {/* Background Image & Gradient */}
  {
    !intro.video?.url && (
      <div class="absolute inset-0 z-0">
        <img
          src={
            intro.image?.asset?.url ||
            "https://placehold.co/1920x1080/e2e8f0/1e293b?text=Intro+Background"
          }
          alt={intro.image?.alt || "Intro Background"}
          class="w-full h-full object-cover"
          fetchpriority="high"
          loading="eager"
        />
        {/* Gradient Overlay for Text Readability */}
        <div class="absolute inset-0 bg-gradient-to-t from-[var(--color-primary)] via-[var(--color-primary)]/40 to-transparent opacity-90 sm:opacity-80" />
      </div>
    )
  }

  <div class="container mx-auto max-w-full relative z-10">
    <div
      class={`grid grid-cols-1 ${intro.video?.url ? "lg:grid-cols-2" : ""} gap-8 items-end`}
    >
      <div class="max-w-4xl text-shadow-sm">
        {
          intro.headline && (
            <h2 class="text-section-header-mobile sm:text-section-header-desktop text-white mb-6">
              {intro.headline}
            </h2>
          )
        }
        {
          intro.subheadline && (
            <p class="text-main-mobile sm:text-main-desktop text-white/95 mb-8 max-w-2xl">
              {intro.subheadline}
            </p>
          )
        }
        {
          intro.content && (
            <div class="prose prose-lg max-w-none">
              {Array.isArray(intro.content) ? (
                // Homepage: content is portableText array
                intro.content.map((block: any) => {
                  if (block._type === "block") {
                    const style = block.style || "normal";
                    const Tag =
                      style === "h1"
                        ? "h1"
                        : style === "h2"
                          ? "h2"
                          : style === "h3"
                            ? "h3"
                            : style === "h4"
                              ? "h4"
                              : style === "blockquote"
                                ? "blockquote"
                                : "p";

                    // Build HTML content from children
                    let htmlContent = "";
                    block.children?.forEach((child: any) => {
                      let text = child.text || "";

                      // Apply marks
                      if (child.marks && child.marks.length > 0) {
                        child.marks.forEach((mark: any) => {
                          if (typeof mark === "string") {
                            if (mark === "strong") {
                              text = `<strong>${text}</strong>`;
                            } else if (mark === "em") {
                              text = `<em>${text}</em>`;
                            } else if (mark === "underline") {
                              text = `<u>${text}</u>`;
                            }
                          } else if (mark?._type === "link") {
                            const target = mark.openInNewTab
                              ? ' target="_blank" rel="noopener noreferrer"'
                              : "";
                            text = `<a href="${mark.href || "#"}" class="text-[var(--color-accent)] hover:underline"${target}>${text}</a>`;
                          }
                        });
                      }

                      htmlContent += text;
                    });

                    return (
                      <Tag
                        class="text-main-mobile sm:text-main-desktop text-white/90 mb-4"
                        set:html={htmlContent}
                      />
                    );
                  }
                  if (block._type === "image" && block.asset) {
                    return null; // Hide inline images in immersive mode
                  }
                  return null;
                })
              ) : (
                // Department pages: content is a simple string
                <p class="text-main-mobile sm:text-main-desktop text-white/90 mb-4 text-justify">
                  {intro.content}
                </p>
              )}
            </div>
          )
        }
        {
          intro.cta && (
            <div class="mt-8">
              <CtaButton cta={intro.cta} />
            </div>
          )
        }
      </div>

      {/* Video Column (Only shown if video exists) */}
      {
        intro.video?.url && (
          <div class="block">
            <div class="aspect-video rounded-lg shadow-xl ring-1 ring-white/15 overflow-hidden">
              <iframe
                src={intro.video.url}
                class="w-full h-full"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              />
            </div>
          </div>
        )
      }
    </div>
  </div>
</section>
