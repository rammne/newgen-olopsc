---
import {getSanityImageUrl, formatDate} from '../../lib/utils/sanity'
import CtaButton from '../common/CtaButton.astro'

interface Props {
  upcomingEvents: {
    title?: string
    count?: number
    cta?: {
      text?: string
      link?: any
      style?: string
      openInNewTab?: boolean
    }
  }
  events: Array<{
    _id?: string
    title?: string
    slug?: {
      current?: string
    }
    startDate?: string
    featuredImage?: {
      asset?: {
        url?: string
      }
      alt?: string
    }
    excerpt?: string
    location?: string
    academicDepartment?: {
      title?: string
    }
  }>
}

const {upcomingEvents, events} = Astro.props
---

{upcomingEvents && events && events.length > 0 && (
  <section class="min-h-[60vh] px-5 py-10 sm:px-[60px] sm:py-[100px] bg-neutral border-t border-[var(--color-neutral)]/30">
    <div class="container mx-auto">
      {upcomingEvents.title && (
        <h2 class="text-section-header-mobile sm:text-section-header-desktop text-[var(--color-primary)] text-center mb-12">
          {upcomingEvents.title}
        </h2>
      )}
      {/* Mobile View: Compact List */}
      <div class="flex flex-col gap-4 mb-8 md:hidden">
        {events.map((event) => (
          <a
            href={`/events/${event.slug?.current || ''}`}
            class="bg-white rounded-lg overflow-hidden shadow-sm flex items-start p-3 gap-4"
          >
            {/* Date Box or Thumbnail */}
            <div class="w-16 h-16 flex-shrink-0 rounded-md overflow-hidden bg-white shadow-sm flex flex-col items-center justify-center text-center">
              {event.startDate ? (
                <>
                  <span class="text-xs text-[var(--color-primary)] font-bold uppercase block">
                    {new Date(event.startDate).toLocaleString('default', { month: 'short' })}
                  </span>
                  <span class="text-xl text-[var(--color-accent)] font-bold block leading-none">
                    {new Date(event.startDate).getDate()}
                  </span>
                </>
              ) : (
                <span class="text-2xl">üìÖ</span>
              )}
            </div>

            <div class="flex-1 min-w-0 py-1">
              <span class="text-[10px] text-[var(--color-primary)]/70 uppercase tracking-wide block mb-1">
                {event.academicDepartment?.title || 'School-wide'}
              </span>
              <h3 class="text-main-mobile text-[var(--color-primary)] font-bold leading-tight line-clamp-2 mb-1">
                {event.title}
              </h3>
              {event.location && (
                <p class="text-small-mobile text-[var(--color-primary)]/80 truncate">
                  üìç {event.location}
                </p>
              )}
            </div>
          </a>
        ))}
      </div>

      {/* Desktop View: Grid */}
      <div class="hidden md:grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        {events.map((event) => (
          <a
            href={`/events/${event.slug?.current || ''}`}
            class="bg-[var(--color-neutral)] rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow group"
          >
            {event.featuredImage?.asset?.url && (
              <div class="aspect-video overflow-hidden">
                <img
                  src={getSanityImageUrl(event.featuredImage, {width: 400, height: 300, fit: 'crop'})}
                  alt={event.featuredImage.alt || event.title || ''}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                />
              </div>
            )}
            <div class="p-6">
              <div class="flex items-center gap-3 mb-2 flex-wrap">
                <span class="text-small-mobile sm:text-small-desktop text-[var(--color-primary)]/70">
                  {event.academicDepartment?.title || 'School-wide'}
                </span>
              </div>
              {event.startDate && (
                <p class="text-small-mobile sm:text-small-desktop text-[var(--color-accent)] font-semibold mb-2">
                  {formatDate(event.startDate)}
                </p>
              )}
              <h3 class="text-card-title-mobile sm:text-card-title-desktop text-[var(--color-primary)] mb-2 group-hover:text-[var(--color-accent)] transition-colors">
                {event.title}
              </h3>
              {event.location && (
                <p class="text-main-mobile sm:text-main-desktop text-[var(--color-primary)] mb-2">
                  üìç {event.location}
                </p>
              )}
              {event.excerpt && (
                <p class="text-main-mobile sm:text-main-desktop text-[var(--color-primary)] line-clamp-2">
                  {event.excerpt}
                </p>
              )}
            </div>
          </a>
        ))}
      </div>
      {upcomingEvents.cta && (
        <div class="text-center">
          <CtaButton cta={upcomingEvents.cta} />
        </div>
      )}
    </div>
  </section>
)}

