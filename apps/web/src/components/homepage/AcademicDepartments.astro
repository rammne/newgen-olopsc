---
import { resolveCtaLink, getSanityImageUrl } from "../../lib/utils/sanity";
import { getDepartmentUrl } from "../../lib/utils/departmentUrls";

interface Props {
  academicDepartments: {
    title?: string;
    subtitle?: string;
    departments?: Array<{
      _id?: string;
      title?: string;
      slug?: {
        current?: string;
      };
      departmentType?:
        | "preschool"
        | "gradeSchool"
        | "juniorHigh"
        | "seniorHigh"
        | "college";
      hero?: {
        backgroundImage?: {
          asset?: {
            url?: string;
          };
          alt?: string;
        };
      };
    }>;
  };
}

const { academicDepartments } = Astro.props;

const departmentTaglines: Record<string, string> = {
  preschool:
    "Sparking curiosity through creative play and values formation.",
  gradeSchool: "Building a strong foundation in academics and character.",
  juniorHigh: "Empowering independent thinkers to discover their passions.",
  seniorHigh: "Specialized tracks that make students college and career-ready.",
  college: "Developing competent, industry-ready professionals.",
};
---

{
  academicDepartments &&
    academicDepartments.departments &&
    academicDepartments.departments.length > 0 && (
      <section class="min-h-[60vh] px-5 py-10 sm:px-[60px] sm:py-[100px] bg-[var(--color-primary)]/10 border-t border-[var(--color-neutral)]/30">
        <div class="container mx-auto">
          {academicDepartments.title && (
            <h2 class="text-section-header-mobile sm:text-section-header-desktop text-primary text-center mb-4">
              {academicDepartments.title}
            </h2>
          )}
          {academicDepartments.subtitle && (
            <p class="text-main-mobile sm:text-main-desktop text-primary text-center mb-10 max-w-3xl mx-auto">
              {academicDepartments.subtitle}
            </p>
          )}
          <div class="departments-scroll-container flex flex-nowrap overflow-x-auto snap-x snap-mandatory pb-4 sm:flex-wrap sm:justify-center sm:items-center gap-4 no-scrollbar">
            {academicDepartments.departments.map((dept) => (
              <a
                href={dept.departmentType ? getDepartmentUrl(dept.departmentType) : `/${dept.slug?.current || ""}`}
                class="acad-card bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 group flex-shrink-0 w-[75vw] sm:w-auto snap-center sm:snap-align-none h-full min-h-[400px] flex flex-col"
              >
                {dept.hero?.backgroundImage?.asset?.url && (
                  <div class="aspect-video overflow-hidden">
                    <img
                      src={getSanityImageUrl(dept.hero.backgroundImage, {
                        width: 400,
                        height: 300,
                        fit: "crop",
                      })}
                      alt={dept.hero.backgroundImage.alt || dept.title || ""}
                      class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 ease-[cubic-bezier(0.22,0.61,0.36,1)]"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                )}
                <div class="p-6 sm:p-7 flex flex-col items-center text-center gap-3 flex-grow">
                  <h3 class="text-card-title-mobile sm:text-card-title-desktop text-[var(--color-primary)] group-hover:text-[var(--color-accent)] transition-colors duration-300">
                    {dept.title}
                  </h3>
                  <p class="text-main-mobile text-[var(--color-primary)]/80 max-w-xs">
                    {departmentTaglines[dept.departmentType || ""]}
                  </p>
                  <div class="mt-auto pt-2 w-full flex justify-center">
                    <span class="h-px w-12 bg-[var(--color-primary)]/40 group-hover:w-20 group-hover:bg-[var(--color-accent)] transition-all duration-500" />
                  </div>
                </div>
              </a>
            ))}
          </div>
          
          {/* Mobile Scroll Progress Indicator */}
          <div class="flex justify-center mt-4 sm:hidden">
            <span class="departments-counter text-small-mobile text-[var(--color-primary)] font-medium bg-white/50 px-3 py-1 rounded-full backdrop-blur-sm border border-[var(--color-neutral)]">
              1 / {academicDepartments.departments.length}
            </span>
          </div>
        </div>
      </section>
    )
}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('.departments-scroll-container');
    const cards = document.querySelectorAll('.acad-card');
    const counter = document.querySelector('.departments-counter');

    if (container && cards.length > 0 && counter) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            // Find index of intersecting card
            const index = Array.from(cards).indexOf(entry.target as Element);
            if (index !== -1) {
              counter.textContent = `${index + 1} / ${cards.length}`;
            }
          }
        });
      }, {
        root: container,
        threshold: 0.6
      });

      cards.forEach(card => observer.observe(card));
    }
  });
</script>
